/*! squel | https://github.com/hiddentao/squel | BSD license */"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _get=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(i)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(t,e){"function"==typeof define&&define.amd?define([],function(){return t.returnExportsGlobal=e()}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e():t.squel=e()}(void 0,function(){function t(t,e){if(t)for(var n=0;n<t.length;++n)e(t[n])}function e(e){for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;n>r;r++)i[r-1]=arguments[r];return i&&t(i,function(t){"object"===("undefined"==typeof t?"undefined":_typeof(t))&&Object.getOwnPropertyNames(t).forEach(function(n){"function"!=typeof t[n]&&(e[n]=t[n])})}),e}function n(t){return t&&t.constructor.prototype===Object.prototype}function i(t){return t&&t.constructor.prototype===Array.prototype}function r(t){if(t&&t.constructor&&t.constructor.toString){var e=t.constructor.toString().match(/function\s*(\w+)/);if(e&&2===e.length)return e[1]}}function s(t){if(!t)return t;if("function"==typeof t.clone)return t.clone();if(!n(t)&&!i(t))return JSON.parse(JSON.stringify(t));var e=function(){var e=new t.constructor;return Object.getOwnPropertyNames(t).forEach(function(n){"function"!=typeof t[n]&&(e[n]=s(t[n]))}),{v:e}}();return"object"===("undefined"==typeof e?"undefined":_typeof(e))?e.v:void 0}function o(t,e,n){var i="undefined"==typeof e?"undefined":_typeof(e);if("function"!==i&&"string"!==i)throw new Error("type must be a class constructor or string");if("function"!=typeof n)throw new Error("handler must be a function");for(var r in t){var s=t[r];if(s.type===e)return void(s.handler=n)}t.push({type:e,handler:n})}function a(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];for(var r in n){var s=n[r];for(var o in s){var a=s[o];if(("undefined"==typeof t?"undefined":_typeof(t))===a.type||"string"!=typeof a.type&&t instanceof a.type)return a.handler}}}function l(){var l=arguments.length<=0||void 0===arguments[0]?null:arguments[0],u={_getObjectClassName:r};u.DefaultQueryBuilderOptions={autoQuoteTableNames:!1,autoQuoteFieldNames:!1,autoQuoteAliasNames:!0,useAsForTableAliasNames:!1,nameQuoteCharacter:"`",tableAliasQuoteCharacter:"`",fieldAliasQuoteCharacter:'"',valueHandlers:[],parameterCharacter:"?",numberedParameters:!1,numberedParametersPrefix:"$",numberedParametersStartAt:1,replaceSingleQuotes:!1,singleQuoteReplacement:"''",separator:" "},u.globalValueHandlers=[],u.registerValueHandler=function(t,e){o(u.globalValueHandlers,t,e)},u.Cloneable=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"clone",value:function(){var t=new this.constructor;return e(t,s(e({},this)))}}]),t}(),u.BaseBuilder=function(t){function n(t){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this)),r=JSON.parse(JSON.stringify(u.DefaultQueryBuilderOptions));return i.options=e({},r,t),i}return _inherits(n,t),_createClass(n,[{key:"registerValueHandler",value:function(t,e){return o(this.options.valueHandlers,t,e),this}},{key:"_sanitizeCondition",value:function(t){if(!(t instanceof u.Expression)&&"string"!=typeof t)throw new Error("condition must be a string or Expression instance");return t}},{key:"_sanitizeName",value:function(t,e){if("string"!=typeof t)throw new Error(e+" must be a string");return t}},{key:"_sanitizeField",value:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t instanceof u.QueryBuilder?t="("+t+")":(t=this._sanitizeName(t,"field name"),this.options.autoQuoteFieldNames&&!function(){var i=e.options.nameQuoteCharacter;t=n.ignorePeriodsForFieldNameQuotes?""+i+t+i:t.split(".").map(function(t){return"*"===t?t:""+i+t+i}).join(".")}()),t}},{key:"_sanitizeNestableQuery",value:function(t){if(t instanceof u.QueryBuilder&&t.isNestable())return t;throw new Error("must be a nestable query, e.g. SELECT")}},{key:"_sanitizeTable",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(e){if("string"!=typeof t)try{t=this._sanitizeNestableQuery(t)}catch(n){throw new Error("table name must be a string or a nestable query instance")}}else t=this._sanitizeName(t,"table name");if(this.options.autoQuoteTableNames){var i=this.options.nameQuoteCharacter;return""+i+t+i}return t}},{key:"_sanitizeTableAlias",value:function(t){var e=this._sanitizeName(t,"table alias");if(this.options.autoQuoteAliasNames){var n=this.options.tableAliasQuoteCharacter;e=""+n+e+n}return this.options.useAsForTableAliasNames?"AS "+e:e}},{key:"_sanitizeFieldAlias",value:function(t){var e=this._sanitizeName(t,"field alias");if(this.options.autoQuoteAliasNames){var n=this.options.fieldAliasQuoteCharacter;return""+n+e+n}return e}},{key:"_sanitizeLimitOffset",value:function(t){if(t=parseInt(t),0>t||isNaN(t))throw new Error("limit/offset must be >= 0");return t}},{key:"_sanitizeValue",value:function(t){var e="undefined"==typeof t?"undefined":_typeof(t);if(null===t);else if("string"===e||"number"===e||"boolean"===e);else if(t instanceof u.QueryBuilder&&t.isNestable());else if(t instanceof u.FunctionBlock);else{var n=!!a(t,this.options.valueHandlers,u.globalValueHandlers);if(!n)throw new Error("field value must be a string, number, boolean, null or one of the registered custom value types")}return t}},{key:"_escapeValue",value:function(t){return this.options.replaceSingleQuotes?t.replace(/\'/g,this.options.singleQuoteReplacement):t}},{key:"_formatCustomValue",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],n=a(t,this.options.valueHandlers,u.globalValueHandlers);return n&&(t=n(t,e)),t}},{key:"_formatValueAsParam",value:function(t){var e=this;return i(t)?t.map(function(t){return e._formatValueAsParam(t)}):t instanceof u.QueryBuilder&&t.isNestable()?(t.updateOptions({nestedBuilder:!0}),t.toParam()):t instanceof u.Expression?t.toParam():this._formatCustomValue(t,!0)}},{key:"_formatValue",value:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=this._formatCustomValue(t);if(r!==t)return"("+r+")";if(i(t))t=t.map(function(t){return e._formatValue(t)}),t="("+t.join(", ")+")";else{var s="undefined"==typeof t?"undefined":_typeof(t);if(null===t)t="NULL";else if("boolean"===s)t=t?"TRUE":"FALSE";else if(t instanceof u.QueryBuilder)t="("+t+")";else if(t instanceof u.Expression)t="("+t+")";else if("number"!==s)if(n.dontQuote)t=""+t;else{var o=this._escapeValue(t);t="'"+o+"'"}}return t}}]),n}(u.Cloneable),u.Expression=function(n){function r(t){_classCallCheck(this,r);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(r).call(this)),i=JSON.parse(JSON.stringify(u.DefaultQueryBuilderOptions));return n.options=e({},i,t),n.tree={nodes:[]},n.stack=[],n}return _inherits(r,n),_createClass(r,[{key:"_begin",value:function(t){var e={type:t,nodes:[]},n=this._current();return this.stack.push(n.nodes.length),n.nodes.push(e),this}},{key:"_current",value:function(){var e=this.tree;return t(this.stack,function(t){e=e.nodes[t]}),e}},{key:"and_begin",value:function(){return this._begin("AND")}},{key:"or_begin",value:function(){return this._begin("OR")}},{key:"end",value:function(){if(!this.stack.length)throw new Error("begin() needs to be called");return this.stack.pop(),this}},{key:"and",value:function(t,e){if(!t||"string"!=typeof t)throw new Error("expr must be a string");return this._current().nodes.push({type:"AND",expr:t,para:e}),this}},{key:"or",value:function(t,e){if(!t||"string"!=typeof t)throw new Error("expr must be a string");return this._current().nodes.push({type:"OR",expr:t,para:e}),this}},{key:"toString",value:function(){if(this.stack.length)throw new Error("end() needs to be called");return this._toString(this.tree)}},{key:"toParam",value:function(){if(this.stack.length)throw new Error("end() needs to be called");return this._toString(this.tree,!0)}},{key:"_toString",value:function(e){var n=this,r=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],s="",o=[];return t(e.nodes,function(t){var e=void 0;if(void 0!==t.expr){if(e=t.expr,void 0!==t.para)if(r){var a=n._formatValueAsParam(t.para);if(a&&a.text?(o=o.concat(a.values),e=e.replace(n.options.parameterCharacter,"("+a.text+")")):o=o.concat(a),i(t.para)){var l=Array.apply(null,new Array(t.para.length)),u=l.map(function(){return n.options.parameterCharacter});e=e.replace(n.options.parameterCharacter,"("+u.join(", ")+")")}}else e=e.replace(n.options.parameterCharacter,n._formatValue(t.para))}else e=n._toString(t,r),r&&(o=o.concat(e.values),e=e.text),e.length&&(e="("+e+")");e.length&&(s.length&&(s+=" "+t.type+" "),s+=e)}),r?{text:s,values:o}:s}}]),r}(u.BaseBuilder),u.Case=function(t){function i(t){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,i);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this));return n(t)&&(r=t,t=null),t&&(s.fieldName=s._sanitizeField(t)),s.options=e({},u.DefaultQueryBuilderOptions,r),s.cases=[],s.elseValue=null,s}return _inherits(i,t),_createClass(i,[{key:"when",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];return this.cases.unshift({expression:t,values:n}),this}},{key:"then",value:function(t){if(0==this.cases.length)throw new Error("when() needs to be called first");return this.cases[0].result=t,this}},{key:"else",value:function(t){return this.elseValue=t,this}},{key:"toString",value:function(){return this._toString(this.cases,this.elseValue)}},{key:"toParam",value:function(){return this._toString(this.cases,this.elseValue,!0)}},{key:"_toString",value:function(t,e){var n=this,i=arguments.length<=2||void 0===arguments[2]?!1:arguments[2];if(0==t.length)return this._formatValue(e);var r=[];t=t.map(function(t){var e=new u.AbstractConditionBlock("WHEN");e._condition.apply(e,[t.expression].concat(t.values));var s="";return i?(e=e.buildParam(),s=e.text,r=r.concat(e.values)):s=e.buildStr(),s+" THEN "+n._formatValue(t.result)});var s=t.join(" ")+" ELSE "+this._formatValue(e)+" END";return this.fieldName&&(s=this.fieldName+" "+s),s="CASE "+s,i?{text:s,values:r}:s}}]),i}(u.BaseBuilder),u.Block=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t))}return _inherits(e,t),_createClass(e,[{key:"exposedMethods",value:function(){for(var t={},e=this;e;)Object.getOwnPropertyNames(e).forEach(function(n){"constructor"===n||"function"!=typeof e[n]||"_"===n.charAt(0)||u.Block.prototype[n]||(t[n]=e[n])}),e=Object.getPrototypeOf(e);return t}},{key:"buildStr",value:function(t){return""}},{key:"buildParam",value:function(t){return{text:this.buildStr(t),values:[]}}}]),e}(u.BaseBuilder),u.StringBlock=function(t){function e(t,n){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return i.str=n,i}return _inherits(e,t),_createClass(e,[{key:"buildStr",value:function(t){return this.str}}]),e}(u.Block),u.AbstractValueBlock=function(e){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e._str="",e._values=[],e}return _inherits(n,e),_createClass(n,[{key:"_setValue",value:function(t){this._str=t;for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._values=n}},{key:"buildStr",value:function(e){var n=this,i=this._str,r="",s=[].concat(this._values);return t(i,function(t){n.options.parameterCharacter===t&&0<s.length&&(t=s.shift()),r+=t}),r}},{key:"buildParam",value:function(t){return{text:this._str,values:this._values}}}]),n}(u.Block),u.FunctionBlock=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"function",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._setValue.apply(this,[t].concat(n))}}]),e}(u.AbstractValueBlock),u.fval=function(){var t=new u.FunctionBlock;return t["function"].apply(t,arguments),t},u.registerValueHandler(u.FunctionBlock,function(t){var e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return e?t.buildParam():t.buildStr()}),u.AbstractTableBlock=function(e){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.tables=[],e}return _inherits(n,e),_createClass(n,[{key:"_table",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];e&&(e=this._sanitizeTableAlias(e)),t=this._sanitizeTable(t,!!this.options.allowNested),this.options.singleTable&&(this.tables=[]),this.tables.push({table:t,alias:e})}},{key:"_hasTable",value:function(){return 0<this.tables.length}},{key:"buildStr",value:function(e){if(!this._hasTable())return"";var n="";return t(this.tables,function(t){n.length&&(n+=", "),n+="string"==typeof t.table?t.table:"("+t.table+")",t.alias&&(n+=" "+t.alias)}),n}},{key:"_buildParam",value:function(e){var n=this,i=arguments.length<=1||void 0===arguments[1]?null:arguments[1],r={text:"",values:[]},s=[],o="";return this._hasTable()?(t(this.tables,function(t){var n=void 0;"string"==typeof t.table?n={text:""+t.table,values:[]}:t.table instanceof u.QueryBuilder?(t.table.updateOptions({nestedBuilder:!0}),n=t.table.toParam()):(t.updateOptions({nestedBuilder:!0}),n=t.buildParam(e)),n.table=t,s.push(n)}),t(s,function(e){o.length?o+=", ":i&&i.length&&(o+=i+" "+o),o+="string"==typeof e.table.table?""+e.text:"("+e.text+")",e.table.alias&&(o+=" "+e.table.alias),t(e.values,function(t){r.values.push(n._formatCustomValue(t))})}),r.text+=o,r):r}},{key:"buildParam",value:function(t){return this._buildParam(t)}}]),n}(u.Block),u.UpdateTableBlock=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"table",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this._table(t,e)}}]),e}(u.AbstractTableBlock),u.FromTableBlock=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"from",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this._table(t,e)}},{key:"buildStr",value:function(t){var n=_get(Object.getPrototypeOf(e.prototype),"buildStr",this).call(this,t);return n.length?"FROM "+n:""}},{key:"buildParam",value:function(t){return this._buildParam(t,"FROM")}}]),e}(u.AbstractTableBlock),u.IntoTableBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.table=null,n}return _inherits(e,t),_createClass(e,[{key:"into",value:function(t){this.table=this._sanitizeTable(t,!1)}},{key:"buildStr",value:function(t){if(!this.table)throw new Error("into() needs to be called");return"INTO "+this.table}}]),e}(u.Block),u.GetFieldBlock=function(e){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e._fieldAliases={},e._fields=[],e}return _inherits(n,e),_createClass(n,[{key:"fields",value:function(e){var n=this,r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(i(e))t(e,function(t){n.field(t,null,r)});else for(var s in e){var o=e[s];this.field(s,o,r)}}},{key:"field",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(e&&(e=this._sanitizeFieldAlias(e)),this._fieldAliases.hasOwnProperty(t)&&this._fieldAliases[t]===e)return this;var i={alias:e};t instanceof u.Case?i.func=t:i.name=this._sanitizeField(t,n),n.aggregation&&(i.aggregation=n.aggregation),this._fieldAliases[t]=e,this._fields.push(i)}},{key:"buildStr",value:function(t){return this._build(t)}},{key:"buildParam",value:function(t){return this._build(t,!0)}},{key:"_build",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(!e.getBlock(u.FromTableBlock)._hasTable())return n?{text:"",values:[]}:"";var i="",r=[];return t(this._fields,function(t){if(i.length&&(i+=", "),t.aggregation&&(i+=t.aggregation+"("),t.func)if(n){var e=t.func.toParam();i+=e.text,r=r.concat(e.values)}else i+=t.func.toString();else i+=t.name;t.aggregation&&(i+=")"),t.alias&&(i+=" AS "+t.alias)}),i.length||(i="*"),n?{text:i,values:r}:i}}]),n}(u.Block),u.AbstractSetFieldBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.fieldOptions=[],n.fields=[],n.values=[],n}return _inherits(e,t),_createClass(e,[{key:"_set",value:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(this.values.length>1)throw new Error("Cannot call set or setFields on multiple rows of fields.");void 0!==e&&(e=this._sanitizeValue(e));var r=this.fields.indexOf(this._sanitizeField(t,n));-1!==r?(this.values[0][r]=e,this.fieldOptions[0][r]=n):(this.fields.push(this._sanitizeField(t,n)),r=this.fields.length-1,i(this.values[0])?(this.values[0][r]=e,this.fieldOptions[0][r]=n):(this.values.push([e]),this.fieldOptions.push([n])))}},{key:"_setFields",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if("object"!==("undefined"==typeof t?"undefined":_typeof(t)))throw new Error("Expected an object but got "+("undefined"==typeof t?"undefined":_typeof(t)));for(var n in t)this._set(n,t[n],e)}},{key:"_setFieldsRows",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(!i(t))throw new Error("Expected an array of objects but got "+("undefined"==typeof t?"undefined":_typeof(t)));this.fields=[],this.values=[];for(var n in t){var r=t[n];for(var s in r){var o=r[s],a=this.fields.indexOf(this._sanitizeField(s,e));if(n>0&&-1===a)throw new Error("All fields in subsequent rows must match the fields in the first row");-1===a&&(this.fields.push(this._sanitizeField(s,e)),a=this.fields.length-1),o=this._sanitizeValue(o),i(this.values[n])?(this.values[n][a]=o,this.fieldOptions[n][a]=e):(this.values[n]=[o],this.fieldOptions[n]=[e])}}}},{key:"buildStr",value:function(){throw new Error("Not yet implemented")}},{key:"buildParam",value:function(){throw new Error("Not yet implemented")}}]),e}(u.Block),u.SetFieldBlock=function(e){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,Object.getPrototypeOf(n).apply(this,arguments))}return _inherits(n,e),_createClass(n,[{key:"set",value:function(t,e,n){this._set(t,e,n)}},{key:"setFields",value:function(t,e){this._setFields(t,e)}},{key:"buildStr",value:function(t){if(0>=this.fields.length)throw new Error("set() needs to be called");var e="";for(var n in this.fields){e.length&&(e+=", ");var i=this.fields[n],r=this.values[0][n],s=this.fieldOptions[0][n];e+="undefined"==typeof r?i:i+" = "+this._formatValue(r,s)}return"SET "+e}},{key:"buildParam",value:function(e){if(0>=this.fields.length)throw new Error("set() needs to be called");var n="",i=[];for(var r in this.fields){n.length&&(n+=", ");var s=this.fields[r],o=this.values[0][r];if("undefined"==typeof o)n+=s;else{var a=this._formatValueAsParam(o);a&&a.text?(n+=s+" = ("+a.text+")",t(a.values,function(t){i.push(t)})):(n+=s+" = "+this.options.parameterCharacter,i.push(a))}}return{text:"SET "+n,values:i}}}]),n}(u.AbstractSetFieldBlock),u.InsertFieldValueBlock=function(e){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,Object.getPrototypeOf(n).apply(this,arguments))}return _inherits(n,e),_createClass(n,[{key:"set",value:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];this._set(t,e,n)}},{key:"setFields",value:function(t,e){this._setFields(t,e)}},{key:"setFieldsRows",value:function(t,e){this._setFieldsRows(t,e)}},{key:"_buildVals",value:function(){var t=[];for(var e in this.values)for(var n in this.values[e]){var i=this._formatValue(this.values[e][n],this.fieldOptions[e][n]);"string"==typeof t[e]?t[e]+=", "+i:t[e]=""+i}return t}},{key:"_buildValParams",value:function(){var e=[],n=[];for(var i in this.values)for(var r in this.values[i]){var s=this._formatValueAsParam(this.values[i][r]),o=void 0;s&&s.text?(o=s.text,t(s.values,function(t){n.push(t)})):(o=this.options.parameterCharacter,n.push(s)),"string"==typeof e[i]?e[i]+=", "+o:e[i]=o}return{vals:e,params:n}}},{key:"buildStr",value:function(t){return 0>=this.fields.length?"":"("+this.fields.join(", ")+") VALUES ("+this._buildVals().join("), (")+")"}},{key:"buildParam",value:function(t){if(0>=this.fields.length)return{text:"",values:[]};var e="",n=this._buildValParams(),i=n.vals,r=n.params;for(var s in this.fields)e.length&&(e+=", "),e+=this.fields[s];return{text:"("+e+") VALUES ("+i.join("), (")+")",values:r}}}]),n}(u.AbstractSetFieldBlock),u.InsertFieldsFromQueryBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._fields=[],n._query=null,n}return _inherits(e,t),_createClass(e,[{key:"fromQuery",value:function(t,e){var n=this;this._fields=t.map(function(t){return n._sanitizeField(t)}),this._query=this._sanitizeNestableQuery(e)}},{key:"buildStr",value:function(t){return 0>=this._fields.length?"":"("+this._fields.join(", ")+") ("+this._query.toString()+")"}},{key:"buildParam",value:function(t){if(0>=this._fields.length)return{text:"",values:[]};this._query.updateOptions({nestedBuilder:!0});var e=this._query.toParam();return{text:"("+this._fields.join(", ")+") ("+e.text+")",values:e.values}}}]),e}(u.Block),u.DistinctBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.useDistinct=!1,n}return _inherits(e,t),_createClass(e,[{key:"distinct",value:function(){this.useDistinct=!0}},{key:"buildStr",value:function(t){return this.useDistinct?"DISTINCT":""}}]),e}(u.Block),u.GroupByBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.groups=[],n}return _inherits(e,t),_createClass(e,[{key:"group",value:function(t){t=this._sanitizeField(t),this.groups.push(t)}},{key:"buildStr",value:function(t){if(0<this.groups.length){var e=this.groups.join(", ");return"GROUP BY "+e}return""}}]),e}(u.Block),u.OffsetBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.offsets=null,n}return _inherits(e,t),_createClass(e,[{key:"offset",value:function(t){t=this._sanitizeLimitOffset(t),this.offsets=t}},{key:"buildStr",value:function(t){return this.offsets?"OFFSET "+this.offsets:""}}]),e}(u.Block),u.AbstractConditionBlock=function(e){function n(t,e){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return i.conditionVerb=t,i.conditions=[],i}return _inherits(n,e),_createClass(n,[{key:"_condition",value:function(e){var n=this;e=this._sanitizeCondition(e);var r="",s=[];if(e instanceof u.Expression){var o=e.toParam();r=o.text,s=o.values}else{for(var a=arguments.length,l=Array(a>1?a-1:0),c=1;a>c;c++)l[c-1]=arguments[c];for(var f in e){var h=e.charAt(f);if(this.options.parameterCharacter===h&&0<l.length){var v=l.shift();i(v)?!function(){var e=[];t(v,function(t){e.push(n._sanitizeValue(t))}),s=s.concat(e);var i=e.map(function(){return n.options.parameterCharacter});r+="("+i.join(", ")+")"}():(r+=this.options.parameterCharacter,s.push(this._sanitizeValue(v)))}else r+=h}}r.length&&this.conditions.push({text:r,values:s})}},{key:"buildStr",value:function(e){var n=this;if(0>=this.conditions.length)return"";var i="";return t(this.conditions,function(e){i.length&&(i+=") AND ("),0<e.values.length?!function(){var r=0;t(e.text,function(t){i+=n.options.parameterCharacter===t?n._formatValue(e.values[r++]):t})}():i+=e.text}),this.conditionVerb+" ("+i+")"}},{key:"buildParam",value:function(e){var n=this,i={text:"",values:[]};if(0>=this.conditions.length)return i;var r="";return t(this.conditions,function(e){r.length&&(r+=") AND (");var s=e.text.split(n.options.parameterCharacter),o=0;t(e.values,function(e){void 0!==s[o]&&(r+=s[o]);var a=n._formatValueAsParam(e);a&&a.text?(r+="("+a.text+")",t(a.values,function(t){i.values.push(t)})):(r+=n.options.parameterCharacter,i.values.push(a)),o+=1}),void 0!==s[o]&&(r+=s[o])}),i.text=this.conditionVerb+" ("+r+")",i}}]),n}(u.Block),u.WhereBlock=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"WHERE",t))}return _inherits(e,t),_createClass(e,[{key:"where",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._condition.apply(this,[t].concat(n))}}]),e}(u.AbstractConditionBlock),u.HavingBlock=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"HAVING",t))}return _inherits(e,t),_createClass(e,[{key:"having",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._condition.apply(this,[t].concat(n))}}]),e}(u.AbstractConditionBlock),u.OrderByBlock=function(e){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.orders=[],e._values=[],e}return _inherits(n,e),_createClass(n,[{key:"order",value:function(t,e){t=this._sanitizeField(t),void 0===e&&(e=!0),null!==e&&(e=!!e);for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;n>r;r++)i[r-2]=arguments[r];this._values=i,this.orders.push({field:t,dir:e})}},{key:"_buildStr",value:function(){var e=this,n=arguments.length<=0||void 0===arguments[0]?!1:arguments[0];if(!(0<this.orders.length))return"";var i=function(){var i=0,r="";return t(e.orders,function(s){r.length&&(r+=", ");var o="";n?o=s.field:t(s.field,function(t){o+=e.options.parameterCharacter===t?e._formatValue(e._values[i++]):t}),r+=o,null!==s.dir&&(r+=" "+(s.dir?"ASC":"DESC"))}),{v:"ORDER BY "+r}}();return"object"===("undefined"==typeof i?"undefined":_typeof(i))?i.v:void 0}},{key:"buildStr",value:function(t){return this._buildStr()}},{key:"buildParam",value:function(t){var e=this;return{text:this._buildStr(!0),values:this._values.map(function(t){return e._formatValueAsParam(t)})}}}]),n}(u.Block),u.LimitBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.limits=null,n}return _inherits(e,t),_createClass(e,[{key:"limit",value:function(t){t=this._sanitizeLimitOffset(t),this.limits=t}},{key:"buildStr",value:function(t){return this.limits||0==this.limits?"LIMIT "+this.limits:""}}]),e}(u.Block),u.JoinBlock=function(e){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.joins=[],e}return _inherits(n,e),_createClass(n,[{key:"join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2],i=arguments.length<=3||void 0===arguments[3]?"INNER":arguments[3];t=this._sanitizeTable(t,!0),e=e?this._sanitizeTableAlias(e):e,n=n?this._sanitizeCondition(n):n,this.joins.push({type:i,table:t,alias:e,condition:n})}},{key:"left_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"LEFT")}},{key:"right_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"RIGHT")}},{key:"outer_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"OUTER")}},{key:"left_outer_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"LEFT OUTER")}},{key:"full_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"FULL")}},{key:"cross_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"CROSS")}},{key:"buildStr",value:function(e){var n="";return t(this.joins||[],function(t){n.length&&(n+=" "),n+=t.type+" JOIN ",n+="string"==typeof t.table?t.table:"("+t.table+")",t.alias&&(n+=" "+t.alias),t.condition&&(n+=" ON ("+t.condition+")")}),n}},{key:"buildParam",value:function(e){var n=this,i={text:"",values:[]},r=[],s="";return 0>=this.joins.length?i:(t(this.joins,function(t){var n=void 0;if("string"==typeof t.table?n={text:""+t.table,values:[]}:t.table instanceof u.QueryBuilder?(t.table.updateOptions({nestedBuilder:!0}),n=t.table.toParam()):(t.updateOptions({nestedBuilder:!0}),n=t.buildParam(e)),t.condition instanceof u.Expression){var i=t.condition.toParam();n.condition=i.text,n.values=n.values.concat(i.values)}else n.condition=t.condition;n.join=t,r.push(n)}),t(r,function(e){s.length&&(s+=" "),s+=e.join.type+" JOIN ",s+="string"==typeof e.join.table?e.text:"("+e.text+")",e.join.alias&&(s+=" "+e.join.alias),e.condition&&(s+=" ON ("+e.condition+")"),t(e.values,function(t){i.values.push(n._formatCustomValue(t))})}),i.text+=s,i)}}]),n}(u.Block),u.UnionBlock=function(e){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.unions=[],e}return _inherits(n,e),_createClass(n,[{key:"union",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?"UNION":arguments[1];t=this._sanitizeTable(t,!0),this.unions.push({type:e,table:t})}},{key:"union_all",value:function(t){this.union(t,"UNION ALL")}},{key:"buildStr",value:function(e){var n="";return t(this.unions||[],function(t){n.length&&(n+=" "),n+=t.type+" ",n+="string"==typeof t.table?t.table:"("+t.table+")"}),n}},{key:"buildParam",value:function(e){var n=this,i={text:"",values:[]},r=[],s="";return 0>=this.unions.length?i:(t(this.unions||[],function(t){var n=void 0;"string"==typeof t.table?n={text:t.table,values:[]}:t.table instanceof u.QueryBuilder?(t.table.updateOptions({nestedBuilder:!0}),n=t.table.toParam()):(t.updateOptions({nestedBuilder:!0}),n=t.buildParam(e)),n.type=t.type,r.push(n)}),t(r,function(e){s.length&&(s+=" "),s+=e.type+" ("+e.text+")",t(e.values,function(t){
i.values.push(n._formatCustomValue(t))})}),i.text+=s,i)}}]),n}(u.Block),u.QueryBuilder=function(n){function i(e,n){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,e));return r.blocks=n||[],t(r.blocks,function(t){var e=t.exposedMethods();for(var n in e){var i=e[n];if(void 0!==r[n])throw new Error("Builder already has a builder method called: "+n);!function(t,e,n){r[e]=function(){for(var e=arguments.length,i=Array(e),s=0;e>s;s++)i[s]=arguments[s];return n.call.apply(n,[t].concat(i)),r}}(t,n,i)}}),r}return _inherits(i,n),_createClass(i,[{key:"registerValueHandler",value:function(e,n){return t(this.blocks,function(t){t.registerValueHandler(e,n)}),_get(Object.getPrototypeOf(i.prototype),"registerValueHandler",this).call(this,e,n),this}},{key:"updateOptions",value:function(n){this.options=e({},this.options,n),t(this.blocks,function(t){t.options=e({},t.options,n)})}},{key:"toString",value:function(){var t=this,e=this.blocks.map(function(e){return e.buildStr(t)});return e.filter(function(t){return 0<t.length}).join(this.options.separator)}},{key:"toParam",value:function(){var t,n=this,i=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=this.options;i&&(this.options=e({},this.options,i));var s={text:"",values:[]},o=this.blocks.map(function(t){return t.buildParam(n)}),a=o.map(function(t){return t.text}),l=o.map(function(t){return t.values});return s.text=a.filter(function(t){return 0<t.length}).join(this.options.separator),s.values=(t=[]).concat.apply(t,_toConsumableArray(l)),this.options.nestedBuilder||this.options.numberedParameters&&!function(){var t=void 0!==n.options.numberedParametersStartAt?n.options.numberedParametersStartAt:1,e=new RegExp("\\"+n.options.parameterCharacter,"g");s.text=s.text.replace(e,function(){return""+n.options.numberedParametersPrefix+t++})}(),this.options=r,s}},{key:"clone",value:function(){var t=this.blocks.map(function(t){return t.clone()});return new this.constructor(this.options,t)}},{key:"isNestable",value:function(){return!1}},{key:"getBlock",value:function(t){var e=this.blocks.filter(function(e){return e instanceof t});return e[0]}}]),i}(u.BaseBuilder),u.Select=function(t){function n(t){var i=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,n),i=i||[new u.StringBlock(t,"SELECT"),new u.FunctionBlock(t),new u.DistinctBlock(t),new u.GetFieldBlock(t),new u.FromTableBlock(e({},t,{allowNested:!0})),new u.JoinBlock(e({},t,{allowNested:!0})),new u.WhereBlock(t),new u.GroupByBlock(t),new u.HavingBlock(t),new u.OrderByBlock(t),new u.LimitBlock(t),new u.OffsetBlock(t),new u.UnionBlock(e({},t,{allowNested:!0}))],_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t,i))}return _inherits(n,t),_createClass(n,[{key:"isNestable",value:function(){return!0}}]),n}(u.QueryBuilder),u.Update=function(t){function e(t){var n=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,e),n=n||[new u.StringBlock(t,"UPDATE"),new u.UpdateTableBlock(t),new u.SetFieldBlock(t),new u.WhereBlock(t),new u.OrderByBlock(t),new u.LimitBlock(t)],_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t,n))}return _inherits(e,t),e}(u.QueryBuilder),u.Delete=function(t){function n(t){var i=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,n),i=i||[new u.StringBlock(t,"DELETE"),new u.FromTableBlock(e({},t,{singleTable:!0})),new u.JoinBlock(t),new u.WhereBlock(t),new u.OrderByBlock(t),new u.LimitBlock(t)],_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t,i))}return _inherits(n,t),n}(u.QueryBuilder),u.Insert=function(t){function e(t){var n=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,e),n=n||[new u.StringBlock(t,"INSERT"),new u.IntoTableBlock(t),new u.InsertFieldValueBlock(t),new u.InsertFieldsFromQueryBlock(t)],_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t,n))}return _inherits(e,t),e}(u.QueryBuilder);var c={VERSION:"4.4.1",flavour:l,expr:function(t){return new u.Expression(t)},"case":function(t,e){return new u.Case(t,e)},select:function(t,e){return new u.Select(t,e)},update:function(t,e){return new u.Update(t,e)},insert:function(t,e){return new u.Insert(t,e)},"delete":function(t,e){return new u.Delete(t,e)},registerValueHandler:u.registerValueHandler,fval:u.fval};return c.remove=c["delete"],c.cls=u,c}var u=l();return u.flavours={},u.useFlavour=function(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];if(!t)return u;if(u.flavours[t]instanceof Function){var e=l(t);return u.flavours[t].call(null,e),e.flavours=u.flavours,e.useFlavour=u.useFlavour,e}throw new Error("Flavour not available: "+t)},u});
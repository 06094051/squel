/*! squel | https://github.com/hiddentao/squel | BSD license */"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _get=function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var s=Object.getPrototypeOf(e);return null===s?void 0:t(s,n,i)}if("value"in r)return r.value;var a=r.get;if(void 0!==a)return a.call(i)},_createClass=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t};!function(t,e){"function"==typeof define&&define.amd?define([],function(){return t.returnExportsGlobal=e()}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e():t.squel=e()}(void 0,function(){function t(t,e){return t.length?t+e:t}function e(t,e){if(t)for(var n=0;n<t.length;++n)e(t[n])}function n(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];if(n){var r=!0,s=!1,a=void 0;try{for(var o,l=function(){var e=o.value;"object"===("undefined"==typeof e?"undefined":_typeof(e))&&Object.getOwnPropertyNames(e).forEach(function(n){"function"!=typeof e[n]&&(t[n]=e[n])})},u=n[Symbol.iterator]();!(r=(o=u.next()).done);r=!0)l()}catch(c){s=!0,a=c}finally{try{!r&&u["return"]&&u["return"]()}finally{if(s)throw a}}}return t}function i(t){return t&&t.constructor.prototype===Object.prototype}function r(t){return t&&t.constructor.prototype===Array.prototype}function s(t){if(t&&t.constructor&&t.constructor.toString){var e=t.constructor.toString().match(/function\s*(\w+)/);if(e&&2===e.length)return e[1]}}function a(t){if(!t)return t;if("function"==typeof t.clone)return t.clone();if(!i(t)&&!r(t))return JSON.parse(JSON.stringify(t));var e=function(){var e=new t.constructor;return Object.getOwnPropertyNames(t).forEach(function(n){"function"!=typeof t[n]&&(e[n]=a(t[n]))}),{v:e}}();return"object"===("undefined"==typeof e?"undefined":_typeof(e))?e.v:void 0}function o(t,e,n){var i="undefined"==typeof e?"undefined":_typeof(e);if("function"!==i&&"string"!==i)throw new Error("type must be a class constructor or string");if("function"!=typeof n)throw new Error("handler must be a function");for(var r in t){var s=t[r];if(s.type===e)return void(s.handler=n)}t.push({type:e,handler:n})}function l(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];for(var r in n){var s=n[r];for(var a in s){var o=s[a];if(("undefined"==typeof t?"undefined":_typeof(t))===o.type||"string"!=typeof o.type&&t instanceof o.type)return o.handler}}}function u(){var u=arguments.length<=0||void 0===arguments[0]?null:arguments[0],c={_getObjectClassName:s};c.DefaultQueryBuilderOptions={autoQuoteTableNames:!1,autoQuoteFieldNames:!1,autoQuoteAliasNames:!0,useAsForTableAliasNames:!1,nameQuoteCharacter:"`",tableAliasQuoteCharacter:"`",fieldAliasQuoteCharacter:'"',valueHandlers:[],parameterCharacter:"?",numberedParameters:!1,numberedParametersPrefix:"$",numberedParametersStartAt:1,replaceSingleQuotes:!1,singleQuoteReplacement:"''",separator:" "},c.globalValueHandlers=[],c.registerValueHandler=function(t,e){o(c.globalValueHandlers,t,e)},c.Cloneable=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"clone",value:function(){var t=new this.constructor;return n(t,a(n({},this)))}}]),t}(),c.BaseBuilder=function(e){function i(t){_classCallCheck(this,i);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this)),r=JSON.parse(JSON.stringify(c.DefaultQueryBuilderOptions));return e.options=n({},r,t),e}return _inherits(i,e),_createClass(i,[{key:"registerValueHandler",value:function(t,e){return o(this.options.valueHandlers,t,e),this}},{key:"_sanitizeExpression",value:function(t){if(!(t instanceof c.Expression)&&"string"!=typeof t)throw new Error("expression must be a stringÂ or Expression instance");return t}},{key:"_sanitizeName",value:function(t,e){if("string"!=typeof t)throw new Error(e+" must be a string");return t}},{key:"_sanitizeField",value:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return t instanceof c.QueryBuilder?t="("+t+")":(t=this._sanitizeName(t,"field name"),this.options.autoQuoteFieldNames&&!function(){var i=e.options.nameQuoteCharacter;t=n.ignorePeriodsForFieldNameQuotes?""+i+t+i:t.split(".").map(function(t){return"*"===t?t:""+i+t+i}).join(".")}()),t}},{key:"_sanitizeNestableQuery",value:function(t){if(t instanceof c.QueryBuilder&&t.isNestable())return t;throw new Error("must be a nestable query, e.g. SELECT")}},{key:"_sanitizeTable",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(e){if("string"!=typeof t)try{t=this._sanitizeNestableQuery(t)}catch(n){throw new Error("table name must be a string or a nestable query instance")}}else t=this._sanitizeName(t,"table name");if(this.options.autoQuoteTableNames){var i=this.options.nameQuoteCharacter;return""+i+t+i}return t}},{key:"_sanitizeTableAlias",value:function(t){var e=this._sanitizeName(t,"table alias");if(this.options.autoQuoteAliasNames){var n=this.options.tableAliasQuoteCharacter;e=""+n+e+n}return this.options.useAsForTableAliasNames?"AS "+e:e}},{key:"_sanitizeFieldAlias",value:function(t){var e=this._sanitizeName(t,"field alias");if(this.options.autoQuoteAliasNames){var n=this.options.fieldAliasQuoteCharacter;return""+n+e+n}return e}},{key:"_sanitizeLimitOffset",value:function(t){if(t=parseInt(t),0>t||isNaN(t))throw new Error("limit/offset must be >= 0");return t}},{key:"_sanitizeValue",value:function(t){var e="undefined"==typeof t?"undefined":_typeof(t);if(null===t);else if("string"===e||"number"===e||"boolean"===e);else if(t instanceof c.QueryBuilder&&t.isNestable());else if(t instanceof c.FunctionBlock);else{var n=!!l(t,this.options.valueHandlers,c.globalValueHandlers);if(!n)throw new Error("field value must be a string, number, boolean, null or one of the registered custom value types")}return t}},{key:"_escapeValue",value:function(t){return this.options.replaceSingleQuotes?t.replace(/\'/g,this.options.singleQuoteReplacement):t}},{key:"_formatCustomValue",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1],n=l(t,this.options.valueHandlers,c.globalValueHandlers);return n&&(t=n(t,e)),t}},{key:"_formatValueAsParam",value:function(t){var e=this;return r(t)?t.map(function(t){return e._formatValueAsParam(t)}):t instanceof c.QueryBuilder&&t.isNestable()?(t.updateOptions({nestedBuilder:!0}),t.toParam()):t instanceof c.Expression?t.toParam():this._formatCustomValue(t,!0)}},{key:"_formatValue",value:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=this._formatCustomValue(t);if(i!==t)return"("+i+")";if(r(t))t=t.map(function(t){return e._formatValue(t)}),t="("+t.join(", ")+")";else{var s="undefined"==typeof t?"undefined":_typeof(t);if(null===t)t="NULL";else if("boolean"===s)t=t?"TRUE":"FALSE";else if(t instanceof c.QueryBuilder)t="("+t+")";else if(t instanceof c.Expression)t="("+t+")";else if("number"!==s)if(n.dontQuote)t=""+t;else{var a=this._escapeValue(t);t="'"+a+"'"}}return t}},{key:"_buildString",value:function(e,n){var i=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];n=n||[],e=e||"";for(var s="",a=-1,o=[],l=this.options.parameterCharacter,u=0;e.length>u;)if(e.substr(u,l.length)===l){var c=n[++a];if(i.buildParameterized){var f=this._formatValueAsParam(c);if(r(f)){for(var h="",v=0;f.length>v;++v)h=t(h,", "),h+=l;s+="("+h+")",o.push.apply(o,_toConsumableArray(f))}else s+=this.options.parameterCharacter,o.push(f)}else s+=this._formatValue(c);u+=l.length}else s+=e.charAt(u),u++;return i.nested&&(s="("+s+")"),{text:s,values:o}}}]),i}(c.Cloneable),c.StringsBuilder=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._strings=[],n._values=[],n}return _inherits(e,t),_createClass(e,[{key:"_addToStrings",value:function(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0],e=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];this.__strings.push(t),this.__values.push(e)}},{key:"_buildAllStrings",value:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=[],n=[];for(var i in this.__strings){var r=this.__strings[i],s=this.__values[i],a=this._processString(r,s,t),o=a.text,l=a.finalValues;e.push(o),n.push.apply(n,_toConsumableArray(l))}return{text:e.join(this.options.separator),values:n}}}]),e}(c.BaseBuilder),c.Expression=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._nodes=[],n}return _inherits(e,t),_createClass(e,[{key:"and",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];return t=this._sanitizeExpression(t),this._nodes.push({type:"AND",expr:t,para:n}),this}},{key:"or",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];return t=this._sanitizeExpression(t),this._nodes.push({type:"OR",expr:t,para:n}),this}},{key:"toString",value:function(){return this._toString().text}},{key:"toParam",value:function(){return this._toString({buildParameterized:!0})}},{key:"_toString",value:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=[],n=[],i=!0,r=!1,s=void 0;try{for(var a,o=this._nodes[Symbol.iterator]();!(i=(a=o.next()).done);i=!0){var l=a.value,u=l.type,f=l.expr,h=l.para,v=f instanceof c.Expression?f._toString({buildParameterized:t.buildParameterized,nested:!0}):this._buildString(f,h,{buildParameterized:t.buildParameterized}),d=v.text,p=v.values;e.length&&e.push(u),e.push(d),n.push.apply(n,_toConsumableArray(p))}}catch(y){r=!0,s=y}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw s}}return e=e.join(" "),t.nested&&(e="("+e+")"),{text:e,values:n}}}]),e}(c.BaseBuilder),c.Case=function(t){function e(t){var r=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,e);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,r));return i(t)&&(r=t,t=null),t&&(s._fieldName=s._sanitizeField(t)),s.options=n({},c.DefaultQueryBuilderOptions,r),s._cases=[],s._elseValue=null,s}return _inherits(e,t),_createClass(e,[{key:"when",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];return this._cases.unshift({expression:t,values:n}),this}},{key:"then",value:function(t){if(0==this._cases.length)throw new Error("when() needs to be called first");return this._cases[0].result=t,this}},{key:"else",value:function(t){return this._elseValue=t,this}},{key:"toString",value:function(){return this._toString().text}},{key:"toParam",value:function(){return this._toString({buildParameterized:!0})}},{key:"_toString",value:function(){var t=this,e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=[],i=[];if(0==this._cases.length)n=""+this._formatValue(this._elseValue);else{var r=this._cases.map(function(n){var r=n.expression,s=n.values,a=n.result,o=new c.AbstractConditionBlock("WHEN");o._condition.apply(o,[r].concat(s));var l="";if(e.buildParameterized){var u=o.buildParam();l=u.text,i.push.apply(i,_toConsumableArray(u.values))}else l=o.buildStr();return l+" THEN "+t._formatValue(a)}),s=r.join(" ")+" ELSE "+this._formatValue(this._elseValue)+" END";this._fieldName&&(s=this._fieldName+" "+s),n="CASE "+s}return{text:n,values:i}}}]),e}(c.BaseBuilder),c.Block=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._strings=[],n._values=[],n}return _inherits(e,t),_createClass(e,[{key:"exposedMethods",value:function(){for(var t={},e=this;e;)Object.getOwnPropertyNames(e).forEach(function(n){"constructor"===n||"function"!=typeof e[n]||"_"===n.charAt(0)||c.Block.prototype[n]||(t[n]=e[n])}),e=Object.getPrototypeOf(e);return t}},{key:"buildStr",value:function(t){return""}},{key:"buildParam",value:function(t){return{text:this.buildStr(t),values:[]}}}]),e}(c.BaseBuilder),c.StringBlock=function(t){function e(t,n){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return i.str=n,i}return _inherits(e,t),_createClass(e,[{key:"buildStr",value:function(t){return this.str}}]),e}(c.Block),c.AbstractValueBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._str="",n._values=[],n}return _inherits(e,t),_createClass(e,[{key:"_setValue",value:function(t){this._str=t;for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._values=n}},{key:"buildStr",value:function(t){var e=this._str,n="",i=[].concat(this._values),r=!0,s=!1,a=void 0;try{for(var o,l=e[Symbol.iterator]();!(r=(o=l.next()).done);r=!0){var u=o.value;this.options.parameterCharacter===u&&0<i.length&&(u=i.shift()),n+=u}}catch(c){s=!0,a=c}finally{try{!r&&l["return"]&&l["return"]()}finally{if(s)throw a}}return n}},{key:"buildParam",value:function(t){return{text:this._str,values:this._values}}}]),e}(c.Block),c.FunctionBlock=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"function",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._setValue.apply(this,[t].concat(n))}}]),e}(c.AbstractValueBlock),c.fval=function(){var t=new c.FunctionBlock;return t["function"].apply(t,arguments),t},c.registerValueHandler(c.FunctionBlock,function(t){var e=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return e?t.buildParam():t.buildStr()}),c.AbstractTableBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.tables=[],n}return _inherits(e,t),_createClass(e,[{key:"_table",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];e&&(e=this._sanitizeTableAlias(e)),t=this._sanitizeTable(t,!!this.options.allowNested),this.options.singleTable&&(this.tables=[]),this.tables.push({table:t,alias:e})}},{key:"_hasTable",value:function(){return 0<this.tables.length}},{key:"buildStr",value:function(t){if(!this._hasTable())return"";var e="",n=!0,i=!1,r=void 0;try{for(var s,a=this.tables[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var o=s.value;e.length&&(e+=", "),e+="string"==typeof o.table?o.table:"("+o.table+")",o.alias&&(e+=" "+o.alias)}}catch(l){i=!0,r=l}finally{try{!n&&a["return"]&&a["return"]()}finally{if(i)throw r}}return e}},{key:"_buildParam",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n={text:"",values:[]},i=[],r="";if(!this._hasTable())return n;var s=!0,a=!1,o=void 0;try{for(var l,u=this.tables[Symbol.iterator]();!(s=(l=u.next()).done);s=!0){var f=l.value,h=void 0;"string"==typeof f.table?h={text:""+f.table,values:[]}:f.table instanceof c.QueryBuilder?(f.table.updateOptions({nestedBuilder:!0}),h=f.table.toParam()):(f.updateOptions({nestedBuilder:!0}),h=f.buildParam(t)),h.table=f,i.push(h)}}catch(v){a=!0,o=v}finally{try{!s&&u["return"]&&u["return"]()}finally{if(a)throw o}}var d=!0,p=!1,y=void 0;try{for(var _,b=i[Symbol.iterator]();!(d=(_=b.next()).done);d=!0){var g=_.value;r.length?r+=", ":e&&e.length&&(r+=e+" "+r),r+="string"==typeof g.table.table?""+g.text:"("+g.text+")",g.table.alias&&(r+=" "+g.table.alias);var k=!0,m=!1,C=void 0;try{for(var O,B=g.values[Symbol.iterator]();!(k=(O=B.next()).done);k=!0){var w=O.value;n.values.push(this._formatCustomValue(w))}}catch(v){m=!0,C=v}finally{try{!k&&B["return"]&&B["return"]()}finally{if(m)throw C}}}}catch(v){p=!0,y=v}finally{try{!d&&b["return"]&&b["return"]()}finally{if(p)throw y}}return n.text+=r,n}},{key:"buildParam",value:function(t){return this._buildParam(t)}}]),e}(c.Block),c.UpdateTableBlock=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"table",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this._table(t,e)}}]),e}(c.AbstractTableBlock),c.FromTableBlock=function(t){function e(){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).apply(this,arguments))}return _inherits(e,t),_createClass(e,[{key:"from",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this._table(t,e)}},{key:"buildStr",value:function(t){var n=_get(Object.getPrototypeOf(e.prototype),"buildStr",this).call(this,t);return n.length?"FROM "+n:""}},{key:"buildParam",value:function(t){return this._buildParam(t,"FROM")}}]),e}(c.AbstractTableBlock),c.IntoTableBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.table=null,n}return _inherits(e,t),_createClass(e,[{key:"into",value:function(t){this.table=this._sanitizeTable(t,!1)}},{key:"buildStr",value:function(t){if(!this.table)throw new Error("into() needs to be called");return"INTO "+this.table}}]),e}(c.Block),c.GetFieldBlock=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e._fieldAliases={},e._fields=[],e}return _inherits(n,t),_createClass(n,[{key:"fields",value:function(t){var n=this,i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(r(t))e(t,function(t){n.field(t,null,i)});else for(var s in t){var a=t[s];this.field(s,a,i)}}},{key:"field",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(e&&(e=this._sanitizeFieldAlias(e)),this._fieldAliases.hasOwnProperty(t)&&this._fieldAliases[t]===e)return this;var i={alias:e};t instanceof c.Case?i.func=t:i.name=this._sanitizeField(t,n),n.aggregation&&(i.aggregation=n.aggregation),this._fieldAliases[t]=e,this._fields.push(i)}},{key:"buildStr",value:function(t){return this._build(t)}},{key:"buildParam",value:function(t){return this._build(t,!0)}},{key:"_build",value:function(t){var n=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];if(!t.getBlock(c.FromTableBlock)._hasTable())return n?{text:"",values:[]}:"";var i="",r=[];return e(this._fields,function(t){if(i.length&&(i+=", "),t.aggregation&&(i+=t.aggregation+"("),t.func)if(n){var e=t.func.toParam();i+=e.text,r=r.concat(e.values)}else i+=t.func.toString();else i+=t.name;t.aggregation&&(i+=")"),t.alias&&(i+=" AS "+t.alias)}),i.length||(i="*"),n?{text:i,values:r}:i}}]),n}(c.Block),c.AbstractSetFieldBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.fieldOptions=[],n.fields=[],n.values=[],n}return _inherits(e,t),_createClass(e,[{key:"_set",value:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];if(this.values.length>1)throw new Error("Cannot call set or setFields on multiple rows of fields.");void 0!==e&&(e=this._sanitizeValue(e));var i=this.fields.indexOf(this._sanitizeField(t,n));-1!==i?(this.values[0][i]=e,this.fieldOptions[0][i]=n):(this.fields.push(this._sanitizeField(t,n)),i=this.fields.length-1,r(this.values[0])?(this.values[0][i]=e,this.fieldOptions[0][i]=n):(this.values.push([e]),this.fieldOptions.push([n])))}},{key:"_setFields",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if("object"!==("undefined"==typeof t?"undefined":_typeof(t)))throw new Error("Expected an object but got "+("undefined"==typeof t?"undefined":_typeof(t)));for(var n in t)this._set(n,t[n],e)}},{key:"_setFieldsRows",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];if(!r(t))throw new Error("Expected an array of objects but got "+("undefined"==typeof t?"undefined":_typeof(t)));this.fields=[],this.values=[];for(var n in t){var i=t[n];for(var s in i){var a=i[s],o=this.fields.indexOf(this._sanitizeField(s,e));if(n>0&&-1===o)throw new Error("All fields in subsequent rows must match the fields in the first row");-1===o&&(this.fields.push(this._sanitizeField(s,e)),o=this.fields.length-1),a=this._sanitizeValue(a),r(this.values[n])?(this.values[n][o]=a,this.fieldOptions[n][o]=e):(this.values[n]=[a],this.fieldOptions[n]=[e])}}}},{key:"buildStr",value:function(){throw new Error("Not yet implemented")}},{key:"buildParam",value:function(){throw new Error("Not yet implemented")}}]),e}(c.Block),c.SetFieldBlock=function(t){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,Object.getPrototypeOf(n).apply(this,arguments))}return _inherits(n,t),_createClass(n,[{key:"set",value:function(t,e,n){this._set(t,e,n)}},{key:"setFields",value:function(t,e){this._setFields(t,e)}},{key:"buildStr",value:function(t){if(0>=this.fields.length)throw new Error("set() needs to be called");var e="";for(var n in this.fields){e.length&&(e+=", ");var i=this.fields[n],r=this.values[0][n],s=this.fieldOptions[0][n];e+="undefined"==typeof r?i:i+" = "+this._formatValue(r,s)}return"SET "+e}},{key:"buildParam",value:function(t){if(0>=this.fields.length)throw new Error("set() needs to be called");var n="",i=[];for(var r in this.fields){n.length&&(n+=", ");var s=this.fields[r],a=this.values[0][r];if("undefined"==typeof a)n+=s;else{var o=this._formatValueAsParam(a);o&&o.text?(n+=s+" = ("+o.text+")",e(o.values,function(t){i.push(t)})):(n+=s+" = "+this.options.parameterCharacter,i.push(o))}}return{text:"SET "+n,values:i}}}]),n}(c.AbstractSetFieldBlock),c.InsertFieldValueBlock=function(t){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,Object.getPrototypeOf(n).apply(this,arguments))}return _inherits(n,t),_createClass(n,[{key:"set",value:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];this._set(t,e,n)}},{key:"setFields",value:function(t,e){this._setFields(t,e)}},{key:"setFieldsRows",value:function(t,e){this._setFieldsRows(t,e)}},{key:"_buildVals",value:function(){var t=[];for(var e in this.values)for(var n in this.values[e]){var i=this._formatValue(this.values[e][n],this.fieldOptions[e][n]);"string"==typeof t[e]?t[e]+=", "+i:t[e]=""+i}return t}},{key:"_buildValParams",value:function(){var t=[],n=[];for(var i in this.values)for(var r in this.values[i]){var s=this._formatValueAsParam(this.values[i][r]),a=void 0;s&&s.text?(a=s.text,e(s.values,function(t){n.push(t)})):(a=this.options.parameterCharacter,n.push(s)),"string"==typeof t[i]?t[i]+=", "+a:t[i]=a}return{vals:t,params:n}}},{key:"buildStr",value:function(t){return 0>=this.fields.length?"":"("+this.fields.join(", ")+") VALUES ("+this._buildVals().join("), (")+")"}},{key:"buildParam",value:function(t){if(0>=this.fields.length)return{text:"",values:[]};var e="",n=this._buildValParams(),i=n.vals,r=n.params;for(var s in this.fields)e.length&&(e+=", "),e+=this.fields[s];return{text:"("+e+") VALUES ("+i.join("), (")+")",values:r}}}]),n}(c.AbstractSetFieldBlock),c.InsertFieldsFromQueryBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n._fields=[],n._query=null,n}return _inherits(e,t),_createClass(e,[{key:"fromQuery",value:function(t,e){var n=this;this._fields=t.map(function(t){return n._sanitizeField(t)}),this._query=this._sanitizeNestableQuery(e)}},{key:"buildStr",value:function(t){return 0>=this._fields.length?"":"("+this._fields.join(", ")+") ("+this._query.toString()+")"}},{key:"buildParam",value:function(t){if(0>=this._fields.length)return{text:"",values:[]};this._query.updateOptions({nestedBuilder:!0});var e=this._query.toParam();return{text:"("+this._fields.join(", ")+") ("+e.text+")",values:e.values}}}]),e}(c.Block),c.DistinctBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.useDistinct=!1,n}return _inherits(e,t),_createClass(e,[{key:"distinct",value:function(){this.useDistinct=!0}},{key:"buildStr",value:function(t){return this.useDistinct?"DISTINCT":""}}]),e}(c.Block),c.GroupByBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.groups=[],n}return _inherits(e,t),_createClass(e,[{key:"group",value:function(t){t=this._sanitizeField(t),this.groups.push(t)}},{key:"buildStr",value:function(t){if(0<this.groups.length){var e=this.groups.join(", ");return"GROUP BY "+e}return""}}]),e}(c.Block),c.OffsetBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.offsets=null,n}return _inherits(e,t),_createClass(e,[{key:"offset",value:function(t){t=this._sanitizeLimitOffset(t),this.offsets=t}},{key:"buildStr",value:function(t){return this.offsets?"OFFSET "+this.offsets:""}}]),e}(c.Block),c.AbstractConditionBlock=function(t){function n(t,e){_classCallCheck(this,n);var i=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,e));return i.conditionVerb=t,i.conditions=[],i}return _inherits(n,t),_createClass(n,[{key:"_condition",value:function(t){var n=this;t=this._sanitizeExpression(t);var i="",s=[];if(t instanceof c.Expression){var a=t.toParam();i=a.text,s=a.values}else{for(var o=arguments.length,l=Array(o>1?o-1:0),u=1;o>u;u++)l[u-1]=arguments[u];for(var f in t){var h=t.charAt(f);if(this.options.parameterCharacter===h&&0<l.length){var v=l.shift();r(v)?!function(){var t=[];e(v,function(e){t.push(n._sanitizeValue(e))}),s=s.concat(t);var r=t.map(function(){return n.options.parameterCharacter});i+="("+r.join(", ")+")"}():(i+=this.options.parameterCharacter,s.push(this._sanitizeValue(v)))}else i+=h}}i.length&&this.conditions.push({text:i,values:s})}},{key:"buildStr",value:function(t){var n=this;if(0>=this.conditions.length)return"";var i="";return e(this.conditions,function(t){i.length&&(i+=") AND ("),0<t.values.length?!function(){var r=0;e(t.text,function(e){i+=n.options.parameterCharacter===e?n._formatValue(t.values[r++]):e})}():i+=t.text}),this.conditionVerb+" ("+i+")"}},{key:"buildParam",value:function(t){var n=this,i={text:"",values:[]};if(0>=this.conditions.length)return i;var r="";return e(this.conditions,function(t){r.length&&(r+=") AND (");var s=t.text.split(n.options.parameterCharacter),a=0;e(t.values,function(t){void 0!==s[a]&&(r+=s[a]);var o=n._formatValueAsParam(t);o&&o.text?(r+="("+o.text+")",e(o.values,function(t){i.values.push(t)})):(r+=n.options.parameterCharacter,i.values.push(o)),a+=1}),void 0!==s[a]&&(r+=s[a])}),i.text=this.conditionVerb+" ("+r+")",i}}]),n}(c.Block),c.WhereBlock=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"WHERE",t))}return _inherits(e,t),_createClass(e,[{key:"where",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._condition.apply(this,[t].concat(n))}}]),e}(c.AbstractConditionBlock),c.HavingBlock=function(t){function e(t){return _classCallCheck(this,e),_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,"HAVING",t))}return _inherits(e,t),_createClass(e,[{key:"having",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;e>i;i++)n[i-1]=arguments[i];this._condition.apply(this,[t].concat(n))}}]),e}(c.AbstractConditionBlock),c.OrderByBlock=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.orders=[],e._values=[],e}return _inherits(n,t),_createClass(n,[{key:"order",value:function(t,e){t=this._sanitizeField(t),void 0===e&&(e=!0),null!==e&&(e=!!e);for(var n=arguments.length,i=Array(n>2?n-2:0),r=2;n>r;r++)i[r-2]=arguments[r];this._values=i,this.orders.push({field:t,dir:e})}},{key:"_buildStr",value:function(){var t=this,n=arguments.length<=0||void 0===arguments[0]?!1:arguments[0];if(!(0<this.orders.length))return"";var i=function(){var i=0,r="";return e(t.orders,function(s){r.length&&(r+=", ");var a="";n?a=s.field:e(s.field,function(e){a+=t.options.parameterCharacter===e?t._formatValue(t._values[i++]):e}),r+=a,null!==s.dir&&(r+=" "+(s.dir?"ASC":"DESC"))}),{v:"ORDER BY "+r}}();return"object"===("undefined"==typeof i?"undefined":_typeof(i))?i.v:void 0}},{key:"buildStr",value:function(t){return this._buildStr()}},{key:"buildParam",value:function(t){var e=this;return{text:this._buildStr(!0),values:this._values.map(function(t){return e._formatValueAsParam(t)})}}}]),n}(c.Block),c.LimitBlock=function(t){function e(t){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t));return n.limits=null,n}return _inherits(e,t),_createClass(e,[{key:"limit",value:function(t){t=this._sanitizeLimitOffset(t),this.limits=t}},{key:"buildStr",value:function(t){return this.limits||0==this.limits?"LIMIT "+this.limits:""}}]),e}(c.Block),c.JoinBlock=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.joins=[],e}return _inherits(n,t),_createClass(n,[{key:"join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2],i=arguments.length<=3||void 0===arguments[3]?"INNER":arguments[3];t=this._sanitizeTable(t,!0),e=e?this._sanitizeTableAlias(e):e,n=n?this._sanitizeExpression(n):n,this.joins.push({type:i,table:t,alias:e,condition:n})}},{key:"left_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"LEFT")}},{key:"right_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"RIGHT")}},{key:"outer_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"OUTER")}},{key:"left_outer_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"LEFT OUTER")}},{key:"full_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"FULL")}},{key:"cross_join",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1],n=arguments.length<=2||void 0===arguments[2]?null:arguments[2];this.join(t,e,n,"CROSS")}},{key:"buildStr",value:function(t){var n="";return e(this.joins||[],function(t){n.length&&(n+=" "),n+=t.type+" JOIN ",n+="string"==typeof t.table?t.table:"("+t.table+")",t.alias&&(n+=" "+t.alias),t.condition&&(n+=" ON ("+t.condition+")")}),n}},{key:"buildParam",value:function(t){var n=this,i={text:"",values:[]},r=[],s="";
return 0>=this.joins.length?i:(e(this.joins,function(e){var n=void 0;if("string"==typeof e.table?n={text:""+e.table,values:[]}:e.table instanceof c.QueryBuilder?(e.table.updateOptions({nestedBuilder:!0}),n=e.table.toParam()):(e.updateOptions({nestedBuilder:!0}),n=e.buildParam(t)),e.condition instanceof c.Expression){var i=e.condition.toParam();n.condition=i.text,n.values=n.values.concat(i.values)}else n.condition=e.condition;n.join=e,r.push(n)}),e(r,function(t){s.length&&(s+=" "),s+=t.join.type+" JOIN ",s+="string"==typeof t.join.table?t.text:"("+t.text+")",t.join.alias&&(s+=" "+t.join.alias),t.condition&&(s+=" ON ("+t.condition+")"),e(t.values,function(t){i.values.push(n._formatCustomValue(t))})}),i.text+=s,i)}}]),n}(c.Block),c.UnionBlock=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,Object.getPrototypeOf(n).call(this,t));return e.unions=[],e}return _inherits(n,t),_createClass(n,[{key:"union",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?"UNION":arguments[1];t=this._sanitizeTable(t,!0),this.unions.push({type:e,table:t})}},{key:"union_all",value:function(t){this.union(t,"UNION ALL")}},{key:"buildStr",value:function(t){var n="";return e(this.unions||[],function(t){n.length&&(n+=" "),n+=t.type+" ",n+="string"==typeof t.table?t.table:"("+t.table+")"}),n}},{key:"buildParam",value:function(t){var n=this,i={text:"",values:[]},r=[],s="";return 0>=this.unions.length?i:(e(this.unions||[],function(e){var n=void 0;"string"==typeof e.table?n={text:e.table,values:[]}:e.table instanceof c.QueryBuilder?(e.table.updateOptions({nestedBuilder:!0}),n=e.table.toParam()):(e.updateOptions({nestedBuilder:!0}),n=e.buildParam(t)),n.type=e.type,r.push(n)}),e(r,function(t){s.length&&(s+=" "),s+=t.type+" ("+t.text+")",e(t.values,function(t){i.values.push(n._formatCustomValue(t))})}),i.text+=s,i)}}]),n}(c.Block),c.QueryBuilder=function(t){function i(t,n){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,t));return r.blocks=n||[],e(r.blocks,function(t){var e=t.exposedMethods();for(var n in e){var i=e[n];if(void 0!==r[n])throw new Error("Builder already has a builder method called: "+n);!function(t,e,n){r[e]=function(){for(var e=arguments.length,i=Array(e),s=0;e>s;s++)i[s]=arguments[s];return n.call.apply(n,[t].concat(i)),r}}(t,n,i)}}),r}return _inherits(i,t),_createClass(i,[{key:"registerValueHandler",value:function(t,n){return e(this.blocks,function(e){e.registerValueHandler(t,n)}),_get(Object.getPrototypeOf(i.prototype),"registerValueHandler",this).call(this,t,n),this}},{key:"updateOptions",value:function(t){this.options=n({},this.options,t),e(this.blocks,function(e){e.options=n({},e.options,t)})}},{key:"toString",value:function(){var t=this,e=this.blocks.map(function(e){return e.buildStr(t)});return e.filter(function(t){return 0<t.length}).join(this.options.separator)}},{key:"toParam",value:function(){var t,e=this,i=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],r=this.options;i&&(this.options=n({},this.options,i));var s={text:"",values:[]},a=this.blocks.map(function(t){return t.buildParam(e)}),o=a.map(function(t){return t.text}),l=a.map(function(t){return t.values});return s.text=o.filter(function(t){return 0<t.length}).join(this.options.separator),s.values=(t=[]).concat.apply(t,_toConsumableArray(l)),this.options.nestedBuilder||this.options.numberedParameters&&!function(){var t=void 0!==e.options.numberedParametersStartAt?e.options.numberedParametersStartAt:1,n=new RegExp("\\"+e.options.parameterCharacter,"g");s.text=s.text.replace(n,function(){return""+e.options.numberedParametersPrefix+t++})}(),this.options=r,s}},{key:"clone",value:function(){var t=this.blocks.map(function(t){return t.clone()});return new this.constructor(this.options,t)}},{key:"getBlock",value:function(t){var e=this.blocks.filter(function(e){return e instanceof t});return e[0]}}]),i}(c.BaseBuilder),c.Select=function(t){function e(t){var i=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,e),i=i||[new c.StringBlock(t,"SELECT"),new c.FunctionBlock(t),new c.DistinctBlock(t),new c.GetFieldBlock(t),new c.FromTableBlock(n({},t,{allowNested:!0})),new c.JoinBlock(n({},t,{allowNested:!0})),new c.WhereBlock(t),new c.GroupByBlock(t),new c.HavingBlock(t),new c.OrderByBlock(t),new c.LimitBlock(t),new c.OffsetBlock(t),new c.UnionBlock(n({},t,{allowNested:!0}))],_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t,i))}return _inherits(e,t),e}(c.QueryBuilder),c.Update=function(t){function e(t){var n=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,e),n=n||[new c.StringBlock(t,"UPDATE"),new c.UpdateTableBlock(t),new c.SetFieldBlock(t),new c.WhereBlock(t),new c.OrderByBlock(t),new c.LimitBlock(t)],_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t,n))}return _inherits(e,t),e}(c.QueryBuilder),c.Delete=function(t){function e(t){var i=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,e),i=i||[new c.StringBlock(t,"DELETE"),new c.FromTableBlock(n({},t,{singleTable:!0})),new c.JoinBlock(t),new c.WhereBlock(t),new c.OrderByBlock(t),new c.LimitBlock(t)],_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t,i))}return _inherits(e,t),e}(c.QueryBuilder),c.Insert=function(t){function e(t){var n=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return _classCallCheck(this,e),n=n||[new c.StringBlock(t,"INSERT"),new c.IntoTableBlock(t),new c.InsertFieldValueBlock(t),new c.InsertFieldsFromQueryBlock(t)],_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this,t,n))}return _inherits(e,t),e}(c.QueryBuilder);var f={VERSION:"4.4.1",flavour:u,expr:function(t){return new c.Expression(t)},"case":function(t,e){return new c.Case(t,e)},select:function(t,e){return new c.Select(t,e)},update:function(t,e){return new c.Update(t,e)},insert:function(t,e){return new c.Insert(t,e)},"delete":function(t,e){return new c.Delete(t,e)},registerValueHandler:c.registerValueHandler,fval:c.fval};return f.remove=f["delete"],f.cls=c,f}var c=u();return c.flavours={},c.useFlavour=function(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];if(!t)return c;if(c.flavours[t]instanceof Function){var e=u(t);return c.flavours[t].call(null,e),e.flavours=c.flavours,e.useFlavour=c.useFlavour,e}throw new Error("Flavour not available: "+t)},c});